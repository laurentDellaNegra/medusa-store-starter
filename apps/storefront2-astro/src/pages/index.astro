---
import { css } from "../../styled-system/css";
import BaseLayout from "../layouts/BaseLayout.astro";
import Preloader from "../components/Preloader.astro";
import Marquee from "../components/Marquee.astro";
import SectionHeader from "../components/SectionHeader.astro";
import ProductCard from "../components/ProductCard.astro";
import ValueCard from "../components/ValueCard.astro";
import Testimonial from "../components/Testimonial.astro";
import Newsletter from "../components/Newsletter.astro";
import Button from "../components/Button.astro";
import { PRODUCTS } from "../data/products";

const heroProducts = PRODUCTS.slice(0, 3);

const marqueeItems = [
  "Handwoven", "Sustainable", "Madagascar", "Artisanal",
  "Luxury", "Raphia", "Ethical", "Timeless",
];

const testimonials = [
  { text: "The most exquisite bag I have ever owned. You can feel the soul of Madagascar in every woven strand.", author: "— Isabelle M., Geneva" },
  { text: "I receive compliments every time I carry my Rafia tote. The craftsmanship is extraordinary.", author: "— Chloé D., Zurich" },
  { text: "Finally, a luxury brand that prioritises both beauty and conscience. It only grows more beautiful with time.", author: "— Sophie L., Lausanne" },
];

const valueIcons = {
  craft: `<svg viewBox="0 0 48 48" fill="none"><path d="M24 4C18 4 8 14 8 24C8 34 18 44 24 44C30 44 40 34 40 24C40 14 30 4 24 4Z" stroke="currentColor" stroke-width="1.5"/><path d="M24 12V24L32 32" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`,
  sustainable: `<svg viewBox="0 0 48 48" fill="none"><path d="M24 4L8 16V32L24 44L40 32V16L24 4Z" stroke="currentColor" stroke-width="1.5"/><path d="M24 4V44M8 16L40 32M40 16L8 32" stroke="currentColor" stroke-width="1" opacity="0.4"/></svg>`,
  fair: `<svg viewBox="0 0 48 48" fill="none"><circle cx="24" cy="24" r="18" stroke="currentColor" stroke-width="1.5"/><path d="M16 24C16 24 20 18 24 18C28 18 32 24 32 24C32 24 28 30 24 30C20 30 16 24 16 24Z" stroke="currentColor" stroke-width="1.5"/><circle cx="24" cy="24" r="3" stroke="currentColor" stroke-width="1.5"/></svg>`,
};

const heroStyle = css({
  display: "grid",
  gridTemplateColumns: "1fr",
  position: "relative",
  overflow: "hidden",
  lg: { height: "100vh", minHeight: "700px", gridTemplateColumns: "1fr 1fr" },
});

const heroLeftStyle = css({
  display: "flex",
  flexDirection: "column",
  justifyContent: "center",
  padding: "8rem 2rem 3rem",
  position: "relative",
  zIndex: "content",
  md: { padding: "10rem 3rem 4rem" },
  lg: { padding: "0 6rem" },
});

const heroTagStyle = css({
  fontSize: "caption",
  letterSpacing: "ultra",
  textTransform: "uppercase",
  color: "gold",
  mb: "2rem",
  fontWeight: "regular",
  opacity: "0",
  transform: "translateY(30px)",
  animation: "fadeUp 1s ease 0.8s forwards",
});

const heroTitleStyle = css({
  fontFamily: "display",
  fontSize: "heading.hero",
  fontWeight: "light",
  lineHeight: "tight",
  color: "espresso",
  mb: "2rem",
  opacity: "0",
  transform: "translateY(40px)",
  animation: "fadeUp 1s ease 1s forwards",
  "& em": { fontStyle: "italic", color: "gold" },
});

const heroDescStyle = css({
  fontSize: "body.md",
  lineHeight: "relaxed",
  color: "espresso.soft",
  maxWidth: "440px",
  mb: "3rem",
  opacity: "0",
  transform: "translateY(40px)",
  animation: "fadeUp 1s ease 1.2s forwards",
});

const heroActionsStyle = css({
  display: "flex",
  gap: "1.5rem",
  alignItems: "center",
  opacity: "0",
  transform: "translateY(30px)",
  animation: "fadeUp 1s ease 1.4s forwards",
});

const heroRightStyle = css({
  position: "relative",
  overflow: "hidden",
  bg: "sand.light",
  height: "60vh",
  lg: { height: "auto" },
});

const heroImageStyle = css({
  position: "absolute",
  inset: "0",
  background: "linear-gradient(135deg, token(colors.sand) 0%, token(colors.gold.light) 50%, token(colors.sand.light) 100%)",
  display: "flex",
  alignItems: "center",
  justifyContent: "center",
  opacity: "0",
  animation: "fadeIn 1.5s ease 0.6s forwards",
});

const heroBagStyle = css({
  width: "320px",
  height: "380px",
  "& svg": {
    width: "100%",
    height: "100%",
    filter: "drop-shadow(0 20px 60px rgba(44, 24, 16, 0.2))",
  },
});

const scrollIndicatorStyle = css({
  position: "absolute",
  bottom: "3rem",
  left: "2rem",
  display: "flex",
  alignItems: "center",
  gap: "1rem",
  fontSize: "sm",
  letterSpacing: "editorial",
  textTransform: "uppercase",
  color: "gold",
  opacity: "0",
  animation: "fadeIn 1s ease 2s forwards",
  lg: { left: "6rem" },
});

const scrollLineStyle = css({
  width: "40px",
  height: "1px",
  bg: "gold",
  animation: "scrollPulse 2s ease-in-out infinite",
});

const cornerStyle = css({
  position: "absolute",
  width: "80px",
  height: "80px",
  border: "1px solid token(colors.gold.light)",
  opacity: "0.4",
});

const aboutStyle = css({
  padding: "6rem 3rem",
  display: "grid",
  gridTemplateColumns: "1fr",
  gap: "4rem",
  alignItems: "center",
  maxWidth: "1400px",
  mx: "auto",
  lg: { gridTemplateColumns: "1fr 1fr", gap: "8rem", padding: "10rem 4rem" },
});

const aboutImageStyle = css({
  aspectRatio: "3/4",
  background: "linear-gradient(160deg, token(colors.sand) 0%, token(colors.gold.light) 100%)",
  position: "relative",
  overflow: "hidden",
  _before: {
    content: '""',
    position: "absolute",
    inset: "1.5rem",
    border: "1px solid rgba(255, 255, 255, 0.4)",
  },
});

const weavePatternStyle = css({
  position: "absolute",
  inset: "0",
  display: "grid",
  gridTemplateColumns: "repeat(8, 1fr)",
  gridTemplateRows: "repeat(10, 1fr)",
  gap: "3px",
  padding: "4rem",
  opacity: "0.3",
});

const weaveCellStyle = css({
  bg: "rgba(255, 255, 255, 0.2)",
  borderRadius: "sm",
  _odd: { bg: "rgba(184, 149, 106, 0.3)" },
});

const aboutLabelStyle = css({
  position: "absolute",
  bottom: "2rem",
  left: "2rem",
  fontSize: "sm",
  letterSpacing: "editorial",
  textTransform: "uppercase",
  color: "white",
  writingMode: "vertical-rl",
});

const aboutContentStyle = css({
  pr: "0",
  lg: { pr: "4rem" },
});

const aboutTextStyle = css({
  fontSize: "body",
  lineHeight: "loose",
  color: "espresso.soft",
  mb: "2.5rem",
});

const statsStyle = css({
  display: "grid",
  gridTemplateColumns: "repeat(3, 1fr)",
  gap: "2rem",
  borderTop: "1px solid token(colors.sand)",
  pt: "2.5rem",
});

const statNumberStyle = css({
  fontFamily: "display",
  fontSize: "2.5rem",
  fontWeight: "light",
  color: "gold",
  lineHeight: "none",
});

const statLabelStyle = css({
  fontSize: "sm",
  letterSpacing: "wide",
  textTransform: "uppercase",
  color: "espresso.soft",
  mt: "0.5rem",
});

const collectionStyle = css({
  padding: "5rem 2rem",
  bg: "sand.pale",
  lg: { padding: "8rem 4rem 10rem" },
});

const collectionGridStyle = css({
  display: "grid",
  gridTemplateColumns: "1fr",
  gap: "2.5rem",
  maxWidth: "400px",
  mx: "auto",
  md: { gridTemplateColumns: "repeat(2, 1fr)", maxWidth: "1300px" },
  lg: { gridTemplateColumns: "repeat(3, 1fr)" },
});

const viewAllStyle = css({ textAlign: "center", mt: "4rem" });

const valuesStyle = css({ padding: "10rem 4rem", maxWidth: "1400px", mx: "auto" });

const valuesGridStyle = css({
  display: "grid",
  gridTemplateColumns: "1fr",
  gap: "3rem",
  lg: { gridTemplateColumns: "repeat(3, 1fr)" },
});

const weaveCount = 80;
---

<BaseLayout title="Rafia — Artisanal Raphia Bags from Madagascar">
  <Preloader />

  <section class={heroStyle}>
    <div class={heroLeftStyle}>
      <div class={cornerStyle} style="top:2rem;left:2rem;border-right:none;border-bottom:none;"></div>
      <p class={heroTagStyle}>Handcrafted in Madagascar</p>
      <h1 class={heroTitleStyle}>The Art of<br /><em>Raphia</em> Weaving</h1>
      <p class={heroDescStyle}>
        Each Rafia bag is a testament to centuries-old Malagasy craftsmanship,
        where every strand tells a story of tradition, elegance, and sustainable luxury.
      </p>
      <div class={heroActionsStyle}>
        <Button visual="primary" href="/shop">Discover Collection</Button>
        <Button visual="ghost" href="/#story">
          Our Story
          <svg width="20" height="12" viewBox="0 0 20 12" fill="none">
            <path d="M14 1L19 6M19 6L14 11M19 6H1" stroke="currentColor" stroke-width="1" />
          </svg>
        </Button>
      </div>
      <div class={scrollIndicatorStyle}>
        <div class={scrollLineStyle}></div>
        Scroll to explore
      </div>
    </div>
    <div class={heroRightStyle}>
      <div class={heroImageStyle}>
        <div class={heroBagStyle}>
          <svg viewBox="0 0 300 380" fill="none">
            <ellipse cx="150" cy="90" rx="60" ry="70" fill="none" stroke="#4A3228" stroke-width="2.5" opacity="0.7"/>
            <path d="M70 160 C70 140,80 125,100 120 L200 120 C220 125,230 140,230 160 L240 330 C240 350,225 360,210 360 L90 360 C75 360,60 350,60 330 Z" fill="url(#bagGrad)" stroke="#4A3228" stroke-width="1.5"/>
            <g opacity="0.25">
              <line x1="80" y1="160" x2="220" y2="160" stroke="#4A3228" stroke-width="0.8"/>
              <line x1="75" y1="185" x2="225" y2="185" stroke="#4A3228" stroke-width="0.8"/>
              <line x1="72" y1="210" x2="228" y2="210" stroke="#4A3228" stroke-width="0.8"/>
              <line x1="68" y1="235" x2="232" y2="235" stroke="#4A3228" stroke-width="0.8"/>
              <line x1="65" y1="260" x2="235" y2="260" stroke="#4A3228" stroke-width="0.8"/>
              <line x1="63" y1="285" x2="237" y2="285" stroke="#4A3228" stroke-width="0.8"/>
              <line x1="110" y1="125" x2="100" y2="355" stroke="#4A3228" stroke-width="0.8"/>
              <line x1="150" y1="120" x2="150" y2="358" stroke="#4A3228" stroke-width="0.8"/>
              <line x1="190" y1="125" x2="200" y2="355" stroke="#4A3228" stroke-width="0.8"/>
            </g>
            <rect x="170" y="280" width="35" height="45" rx="2" fill="#FFFCF7" opacity="0.8"/>
            <line x1="178" y1="295" x2="198" y2="295" stroke="#B8956A" stroke-width="0.8"/>
            <line x1="178" y1="302" x2="193" y2="302" stroke="#B8956A" stroke-width="0.8"/>
            <defs>
              <linearGradient id="bagGrad" x1="60" y1="120" x2="240" y2="360">
                <stop offset="0%" stop-color="#D4C5B2"/>
                <stop offset="50%" stop-color="#C4AD92"/>
                <stop offset="100%" stop-color="#BFA88C"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
      </div>
      <div class={cornerStyle} style="bottom:2rem;right:2rem;border-left:none;border-top:none;"></div>
    </div>
  </section>

  <Marquee items={marqueeItems} />

  <section class={aboutStyle} id="story">
    <div class={`${aboutImageStyle} reveal`}>
      <div class={weavePatternStyle}>
        {Array.from({ length: weaveCount }).map(() => (
          <div class={weaveCellStyle}></div>
        ))}
      </div>
      <span class={aboutLabelStyle}>Est. 2024 — Madagascar</span>
    </div>
    <div class={aboutContentStyle}>
      <SectionHeader tag="Our Story" title="Born from the <em>Heart</em><br>of Madagascar" />
      <p class={`${aboutTextStyle} reveal reveal-delay-2`}>
        Rafia was founded on a simple yet profound belief: that true luxury lies
        in authenticity. Our bags are meticulously hand-woven by skilled artisans
        in Madagascar, where the art of raphia weaving has been passed down
        through generations.
      </p>
      <div class={`${statsStyle} reveal reveal-delay-3`}>
        <div>
          <div class={statNumberStyle}>150+</div>
          <div class={statLabelStyle}>Artisan partners</div>
        </div>
        <div>
          <div class={statNumberStyle}>100%</div>
          <div class={statLabelStyle}>Natural materials</div>
        </div>
        <div>
          <div class={statNumberStyle}>7–14</div>
          <div class={statLabelStyle}>Days per piece</div>
        </div>
      </div>
    </div>
  </section>

  <section class={collectionStyle} id="collection">
    <div class={css({ textAlign: "center", maxWidth: "600px", mx: "auto", mb: "5rem" })}>
      <SectionHeader tag="The Collection" title="Curated <em>Pieces</em>" centered />
    </div>
    <div class={collectionGridStyle}>
      {heroProducts.map((product, i) => (
        <div class={`reveal ${i > 0 ? `reveal-delay-${i}` : ""}`}>
          <ProductCard product={product} showAddButton />
        </div>
      ))}
    </div>
    <div class={`${viewAllStyle} reveal`}>
      <Button visual="outline" href="/shop">View All Bags</Button>
    </div>
  </section>

  <section class={valuesStyle} id="values">
    <div class={css({ textAlign: "center", maxWidth: "550px", mx: "auto", mb: "6rem" })}>
      <SectionHeader tag="Our Savoir-Faire" title="Crafted with <em>Purpose</em>" centered />
    </div>
    <div class={valuesGridStyle}>
      <ValueCard
        iconSvg={valueIcons.craft}
        title="Time-Honoured Craft"
        description="Each bag requires 7 to 14 days of meticulous hand-weaving, using techniques perfected over centuries."
      />
      <ValueCard
        iconSvg={valueIcons.sustainable}
        title="Sustainable Luxury"
        description="Raphia is a naturally renewable palm fibre — biodegradable, durable, and harvested sustainably."
        delay={1}
      />
      <ValueCard
        iconSvg={valueIcons.fair}
        title="Fair Partnership"
        description="We work directly with artisan cooperatives, ensuring fair wages and sustainable livelihoods."
        delay={2}
      />
    </div>
  </section>

  <Testimonial testimonials={testimonials} />
  <Newsletter />
</BaseLayout>

<script is:inline define:vars={{ products: PRODUCTS.slice(0, 3).map(p => ({ id: p.id, name: p.name, price: p.price, type: p.type, color: p.color, gradient: p.gradient, svg: p.svg })) }}>
  window.__RAFIA_PRODUCTS = products;
</script>

<script>
  function initHomeAddToBag() {
    document.querySelectorAll<HTMLButtonElement>(".product-action").forEach((btn) => {
      btn.addEventListener("click", (e: Event) => {
        e.preventDefault();
        e.stopPropagation();
        const card = btn.closest(".product-card") as HTMLAnchorElement | null;
        if (!card) return;
        const href = card.getAttribute("href") || "";
        const id = new URLSearchParams(href.split("?")[1]).get("id");
        if (!id) return;
        const products = (window as any).__RAFIA_PRODUCTS as any[];
        if (!products) return;
        const product = products.find((p: any) => p.id === id);
        if (!product) return;

        const cart: any[] = JSON.parse(localStorage.getItem("rafia_cart") || "[]");
        const existing = cart.find((c: any) => c.id === product.id);
        if (existing) { existing.qty += 1; }
        else { cart.push({ ...product, qty: 1 }); }
        localStorage.setItem("rafia_cart", JSON.stringify(cart));

        const count = cart.reduce((s: number, i: any) => s + i.qty, 0);
        document.querySelectorAll<HTMLElement>(".cart-count").forEach((el) => {
          el.textContent = String(count);
          el.style.display = count > 0 ? "flex" : "none";
          el.classList.remove("bump");
          void el.offsetWidth;
          el.classList.add("bump");
        });

        const n = document.getElementById("cartNotification");
        if (n) {
          n.innerHTML = `<span style="color:#B8956A;">✓</span>&ensp;${product.name} added to bag`;
          n.classList.add("visible");
          clearTimeout((n as any)._timer);
          (n as any)._timer = setTimeout(() => n.classList.remove("visible"), 2800);
        }
      });
    });
  }
  initHomeAddToBag();
</script>

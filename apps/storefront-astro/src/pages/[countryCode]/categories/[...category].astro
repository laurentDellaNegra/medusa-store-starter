---
export const prerender = false

import MainLayout from "@/layouts/MainLayout.astro"
import ProductGrid from "@/components/store/ProductGrid.astro"
import Pagination from "@/components/store/Pagination.astro"
import SortDropdown from "@/components/store/SortDropdown"
import { getCategoryByHandle } from "@/lib/data/categories"
import { listProductsWithSort } from "@/lib/data/products"
import { css } from "styled-system/css"
import type { SortOptions } from "@/lib/util/sort-products"

const { countryCode, category: categoryPath } = Astro.params

if (!countryCode || !categoryPath) {
  return Astro.redirect("/us")
}

const categoryHandle = categoryPath.split("/")
const category = await getCategoryByHandle(categoryHandle)

if (!category) {
  return Astro.redirect(`/${countryCode}/store`)
}

const url = Astro.url
const page = Number(url.searchParams.get("page")) || 1
const sortBy = (url.searchParams.get("sortBy") as SortOptions) || "created_at"
const limit = 12

const { response } = await listProductsWithSort({
  page,
  sortBy,
  countryCode,
  queryParams: { limit, category_id: [category.id] },
})

const totalPages = Math.ceil(response.count / limit)
const baseUrl = `/${countryCode}/categories/${categoryPath}`
---

<MainLayout title={`${category.name} | Medusa Store`} countryCode={countryCode}>
  <div class={css({
    maxW: "8xl",
    mx: "auto",
    px: { base: "4", md: "8" },
    py: "8",
  })}>
    <div class={css({
      display: "flex",
      justifyContent: "space-between",
      alignItems: "center",
      mb: "8",
    })}>
      <div>
        <h1 class={css({ fontSize: "2xl", fontWeight: "medium" })}>
          {category.name}
        </h1>
        {category.description && (
          <p class={css({ fontSize: "sm", color: "fg.muted", mt: "1" })}>
            {category.description}
          </p>
        )}
      </div>
      <SortDropdown client:load currentSort={sortBy} baseUrl={baseUrl} />
    </div>

    <ProductGrid products={response.products} countryCode={countryCode} />
    <Pagination
      currentPage={page}
      totalPages={totalPages}
      baseUrl={baseUrl}
      sortBy={sortBy}
    />
  </div>
</MainLayout>

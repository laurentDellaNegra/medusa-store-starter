---
import { css } from "../../styled-system/css";
import BaseLayout from "../layouts/BaseLayout.astro";
import Button from "../components/Button.astro";

const pageStyle = css({
  padding: "7rem 1.5rem 3rem",
  maxWidth: "1200px",
  mx: "auto",
  minHeight: "60vh",
  lg: { padding: "9rem 4rem 4rem" },
});

const headerStyle = css({
  display: "flex",
  flexDirection: "column",
  gap: "0.5rem",
  mb: "3rem",
  pb: "1.5rem",
  borderBottom: "1px solid token(colors.sand)",
  md: { flexDirection: "row", justifyContent: "space-between", alignItems: "baseline", gap: "0" },
});

const titleStyle = css({
  fontFamily: "display",
  fontSize: "clamp(2rem, 3.5vw, 3rem)",
  fontWeight: "light",
  "& em": { fontStyle: "italic", color: "gold" },
});

const countStyle = css({
  fontSize: "0.75rem",
  letterSpacing: "wide",
  textTransform: "uppercase",
  color: "espresso.soft",
});

const layoutStyle = css({
  display: "grid",
  gridTemplateColumns: "1fr",
  gap: "4rem",
  alignItems: "start",
  lg: { gridTemplateColumns: "1fr 380px" },
});
---

<BaseLayout title="Shopping Bag — Rafia" navVariant="light">
  <section class={pageStyle}>
    <div class={headerStyle}>
      <h1 class={titleStyle}>Your <em>Bag</em></h1>
      <span class={countStyle} id="cartItemCount"></span>
    </div>
    <div class={layoutStyle} id="cartLayout"></div>
  </section>
</BaseLayout>

<script>
  function renderCart() {
    const items: any[] = JSON.parse(localStorage.getItem("rafia_cart") || "[]");
    const layout = document.getElementById("cartLayout");
    const countEl = document.getElementById("cartItemCount");
    if (!layout) return;

    if (items.length === 0) {
      if (countEl) countEl.textContent = "0 items";
      layout.innerHTML = `
        <div style="text-align:center;padding:6rem 2rem;grid-column:1/-1;">
          <div style="margin-bottom:2rem;color:#E8DFD0;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="width:64px;height:64px;">
              <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
              <line x1="3" y1="6" x2="21" y2="6"/>
              <path d="M16 10a4 4 0 01-8 0"/>
            </svg>
          </div>
          <h2 style="font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:300;margin-bottom:1rem;">Your bag is empty</h2>
          <p style="font-size:0.9rem;color:#4A3228;margin-bottom:2.5rem;line-height:1.7;">Looks like you haven't added any pieces to your bag yet.<br>Explore our collection and find your perfect companion.</p>
          <a href="/shop" style="display:inline-block;padding:1rem 3rem;background:#2C1810;color:#F4EDE3;font-family:'Outfit',sans-serif;font-size:0.7rem;letter-spacing:0.25em;text-transform:uppercase;text-decoration:none;position:relative;overflow:hidden;"><span style="position:relative;z-index:1;">Browse Collection</span></a>
        </div>`;
      return;
    }

    const totalItems = items.reduce((s: number, i: any) => s + i.qty, 0);
    if (countEl) countEl.textContent = `${totalItems} item${totalItems !== 1 ? "s" : ""}`;

    const subtotal = items.reduce((s: number, i: any) => s + i.price * i.qty, 0);
    const shipping = subtotal >= 150 ? 0 : 12;
    const total = subtotal + shipping;

    let itemsHtml = '<div style="display:flex;flex-direction:column;">';
    items.forEach((item: any, idx: number) => {
      itemsHtml += `
        <div class="cart-item" data-id="${item.id}" style="display:grid;grid-template-columns:120px 1fr auto;gap:2rem;padding:2rem 0;border-bottom:1px solid #E8DFD0;align-items:center;animation:fadeInItem 0.5s ease forwards;opacity:0;animation-delay:${idx * 0.05}s;">
          <a href="/product?id=${item.id}" style="aspect-ratio:3/4;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;text-decoration:none;">
            <div style="position:absolute;inset:0;background:${item.gradient || "#E8DFD0"};"></div>
            <div style="position:relative;z-index:1;width:55%;filter:drop-shadow(0 5px 15px rgba(44,24,16,0.12));">${item.svg || ""}</div>
          </a>
          <div style="display:flex;flex-direction:column;gap:0.4rem;">
            <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:400;"><a href="/product?id=${item.id}" style="color:#2C1810;text-decoration:none;">${item.name}</a></h3>
            <p style="font-size:0.7rem;letter-spacing:0.12em;text-transform:uppercase;color:#4A3228;">${item.type || ""} ${item.color ? "— " + item.color : ""}</p>
            <p style="font-family:'Cormorant Garamond',serif;font-size:1.1rem;color:#B8956A;margin-top:0.3rem;">CHF ${item.price}</p>
            <div style="display:flex;align-items:center;gap:1.5rem;margin-top:0.8rem;">
              <div style="display:flex;align-items:center;border:1px solid #E8DFD0;">
                <button class="ci-qty-btn" data-action="minus" data-id="${item.id}" style="width:34px;height:34px;border:none;background:transparent;font-size:0.95rem;color:#2C1810;cursor:pointer;font-family:'Outfit',sans-serif;">&minus;</button>
                <input type="text" value="${item.qty}" readonly style="width:38px;text-align:center;border:none;border-left:1px solid #E8DFD0;border-right:1px solid #E8DFD0;font-family:'Outfit',sans-serif;font-size:0.8rem;height:34px;background:transparent;color:#2C1810;outline:none;">
                <button class="ci-qty-btn" data-action="plus" data-id="${item.id}" style="width:34px;height:34px;border:none;background:transparent;font-size:0.95rem;color:#2C1810;cursor:pointer;font-family:'Outfit',sans-serif;">+</button>
              </div>
              <button class="ci-remove" data-id="${item.id}" style="font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:#4A3228;background:none;border:none;cursor:pointer;text-decoration:underline;text-underline-offset:3px;font-family:'Outfit',sans-serif;">Remove</button>
            </div>
          </div>
          <div style="font-family:'Cormorant Garamond',serif;font-size:1.3rem;color:#2C1810;text-align:right;white-space:nowrap;">CHF ${item.price * item.qty}</div>
        </div>`;
    });
    itemsHtml += "</div>";

    const summaryHtml = `
      <div style="background:#FAF7F2;padding:2.5rem;position:sticky;top:7rem;">
        <h2 style="font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:400;margin-bottom:2rem;padding-bottom:1.2rem;border-bottom:1px solid #E8DFD0;">Order Summary</h2>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:0.7rem 0;"><span style="font-size:0.8rem;letter-spacing:0.08em;color:#4A3228;">Subtotal</span><span style="font-size:0.9rem;color:#2C1810;">CHF ${subtotal}</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:0.7rem 0;"><span style="font-size:0.8rem;letter-spacing:0.08em;color:#4A3228;">Shipping</span><span style="font-size:0.9rem;color:#2C1810;">${shipping === 0 ? "Complimentary" : "CHF " + shipping}</span></div>
        <div style="margin-top:1.5rem;">
          <button id="promoToggle" style="font-size:0.7rem;letter-spacing:0.12em;text-transform:uppercase;color:#B8956A;background:none;border:none;cursor:pointer;font-family:'Outfit',sans-serif;text-decoration:underline;text-underline-offset:3px;">Add promo code</button>
          <div id="promoForm" style="display:none;margin-top:0.8rem;flex-direction:row;gap:0;">
            <input type="text" placeholder="Enter code" style="flex:1;padding:0.7rem 1rem;border:1px solid #E8DFD0;border-right:none;background:white;font-family:'Outfit',sans-serif;font-size:0.8rem;color:#2C1810;outline:none;">
            <button style="padding:0.7rem 1.2rem;background:#2C1810;color:#F4EDE3;font-family:'Outfit',sans-serif;font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;border:1px solid #2C1810;cursor:pointer;">Apply</button>
          </div>
        </div>
        <div style="height:1px;background:#E8DFD0;margin:1rem 0;"></div>
        <div style="display:flex;justify-content:space-between;align-items:baseline;padding-top:1rem;">
          <span style="font-size:0.7rem;letter-spacing:0.2em;text-transform:uppercase;color:#2C1810;">Total</span>
          <span style="font-family:'Cormorant Garamond',serif;font-size:1.8rem;color:#2C1810;">CHF ${total}</span>
        </div>
        <button class="cs-checkout-btn" style="width:100%;padding:1.1rem;margin-top:2rem;background:#2C1810;color:#F4EDE3;font-family:'Outfit',sans-serif;font-size:0.75rem;letter-spacing:0.25em;text-transform:uppercase;border:none;cursor:pointer;position:relative;overflow:hidden;"><span style="position:relative;z-index:1;">Proceed to Checkout</span></button>
        <a href="/shop" style="display:block;text-align:center;margin-top:1.2rem;font-size:0.7rem;letter-spacing:0.15em;text-transform:uppercase;color:#B8956A;text-decoration:none;">Continue Shopping</a>
        <div style="margin-top:2rem;padding-top:1.5rem;border-top:1px solid #E8DFD0;display:flex;flex-direction:column;gap:0.8rem;">
          <div style="display:flex;align-items:center;gap:0.8rem;font-size:0.72rem;letter-spacing:0.08em;color:#4A3228;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#B8956A" stroke-width="1.5" style="width:16px;height:16px;flex-shrink:0;"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
            Free shipping over CHF 150
          </div>
          <div style="display:flex;align-items:center;gap:0.8rem;font-size:0.72rem;letter-spacing:0.08em;color:#4A3228;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#B8956A" stroke-width="1.5" style="width:16px;height:16px;flex-shrink:0;"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
            14-day returns
          </div>
          <div style="display:flex;align-items:center;gap:0.8rem;font-size:0.72rem;letter-spacing:0.08em;color:#4A3228;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#B8956A" stroke-width="1.5" style="width:16px;height:16px;flex-shrink:0;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
            Secure checkout
          </div>
        </div>
      </div>`;

    layout.innerHTML = itemsHtml + summaryHtml;

    // Qty buttons
    layout.querySelectorAll<HTMLButtonElement>(".ci-qty-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.id!;
        const action = btn.dataset.action;
        const cart: any[] = JSON.parse(localStorage.getItem("rafia_cart") || "[]");
        const item = cart.find((i: any) => i.id === id);
        if (!item) return;
        if (action === "plus") { item.qty += 1; }
        else if (action === "minus") {
          if (item.qty <= 1) {
            const idx = cart.indexOf(item);
            cart.splice(idx, 1);
          } else { item.qty -= 1; }
        }
        localStorage.setItem("rafia_cart", JSON.stringify(cart));
        updateBadge(cart);
        renderCart();
      });
    });

    // Remove buttons
    layout.querySelectorAll<HTMLButtonElement>(".ci-remove").forEach((btn) => {
      btn.addEventListener("click", () => {
        const el = btn.closest(".cart-item") as HTMLElement;
        if (el) {
          el.style.transition = "opacity 0.4s, transform 0.4s";
          el.style.opacity = "0";
          el.style.transform = "translateX(-30px)";
        }
        setTimeout(() => {
          const cart: any[] = JSON.parse(localStorage.getItem("rafia_cart") || "[]");
          const filtered = cart.filter((i: any) => i.id !== btn.dataset.id);
          localStorage.setItem("rafia_cart", JSON.stringify(filtered));
          updateBadge(filtered);
          renderCart();
        }, 400);
      });
    });

    // Promo toggle
    const pt = document.getElementById("promoToggle");
    const pf = document.getElementById("promoForm");
    if (pt && pf) {
      pt.addEventListener("click", () => {
        pf.style.display = pf.style.display === "flex" ? "none" : "flex";
      });
    }

    // Checkout
    layout.querySelector<HTMLButtonElement>(".cs-checkout-btn")?.addEventListener("click", function (this: HTMLButtonElement) {
      const span = this.querySelector("span");
      if (!span) return;
      span.textContent = "Processing...";
      setTimeout(() => {
        span.textContent = "Thank you!";
        setTimeout(() => {
          localStorage.setItem("rafia_cart", "[]");
          updateBadge([]);
          renderCart();
        }, 1500);
      }, 1500);
    });
  }

  function updateBadge(cart: any[]) {
    const count = cart.reduce((s: number, i: any) => s + i.qty, 0);
    document.querySelectorAll<HTMLElement>(".cart-count").forEach((el) => {
      el.textContent = String(count);
      el.style.display = count > 0 ? "flex" : "none";
    });
  }

  renderCart();
</script>

<style is:inline>
  @keyframes fadeInItem { to { opacity: 1; } }
</style>

---
import type { Product } from "../data/products";
import Breadcrumb from "./Breadcrumb.astro";
import QuantitySelector from "./QuantitySelector.astro";

interface Props {
  product: Product;
}

const { product } = Astro.props;

const swatches = [
  { name: "Natural", color: "#D4C5B2" },
  { name: "Honey", color: "#C4A872" },
  { name: "Sand", color: "#BFA98E" },
];

const productDetailsContent =
  "<ul>" + product.details.map((d) => "<li>" + d + "</li>").join("") + "</ul>";

const accordionItems = [
  {
    title: "Product Details",
    content: productDetailsContent,
    open: true,
  },
  {
    title: "Shipping & Returns",
    content:
      "<p>Complimentary shipping within Switzerland. International shipping available. 14-day return policy for unworn items in original packaging.</p>",
    open: false,
  },
  {
    title: "Care Instructions",
    content:
      "<p>Store in the provided dust bag when not in use. Avoid prolonged exposure to direct sunlight and moisture. Gently brush with a soft cloth to remove dust.</p>",
    open: false,
  },
];
---

<div class="pdp-info" id="pdpInfo">
  <Breadcrumb
    crumbs={[
      { label: "Home", href: "/" },
      { label: "Collection", href: "/shop" },
    ]}
    current={product.name}
  />
  <p class="pdp-type">{product.type}</p>
  <h1 class="pdp-name">{product.name}</h1>
  <p class="pdp-price">CHF {product.price}</p>
  <div class="pdp-divider"></div>
  <p class="pdp-desc">{product.description}</p>

  <p class="pdp-option-label">
    Colour — <strong>{product.color}</strong>
  </p>
  <div class="pdp-color-row">
    {
      swatches.map((sw, i) => (
        <div
          class={`pdp-swatch color-swatch ${i === 0 ? "active" : ""}`}
          style={`background:${sw.color}`}
          title={sw.name}
        />
      ))
    }
  </div>

  <p class="pdp-option-label">Quantity</p>
  <div class="pdp-qty-row">
    <QuantitySelector size="md" id="qty" />
  </div>

  <button class="pdp-add-btn gold-slide-in" id="addToCartBtn">
    <span>Add to Bag — CHF {product.price}</span>
  </button>

  <div class="pdp-secondary">
    <a href="#" class="pdp-sec-link">
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path
          d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"
        ></path>
      </svg>
      Add to Wishlist
    </a>
    <a href="#" class="pdp-sec-link">
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"
        ></circle>
        <circle cx="18" cy="19" r="3"></circle>
        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
      </svg>
      Share
    </a>
  </div>

  <div class="pdp-accordion">
    {
      accordionItems.map((item) => (
        <div class={`acc-item ${item.open ? "open" : ""}`}>
          <div class="acc-header">
            <span class="acc-header__text">{item.title}</span>
            <div class="acc-icon" />
          </div>
          <div class="acc-body">
            <div class="acc-body__inner" set:html={item.content} />
          </div>
        </div>
      ))
    }
  </div>
</div>

<script
  define:vars={{
    productId: product.id,
    productName: product.name,
    productPrice: product.price,
    productType: product.type,
    productColor: product.color,
    productGradient: product.gradient,
    productSvg: product.svg,
  }}
>
  let qty = 1;

  document.getElementById("qtyMinus")?.addEventListener("click", () => {
    if (qty > 1) {
      qty--;
      document.getElementById("qtyVal").value = String(qty);
      updatePrice();
    }
  });

  document.getElementById("qtyPlus")?.addEventListener("click", () => {
    qty++;
    document.getElementById("qtyVal").value = String(qty);
    updatePrice();
  });

  function updatePrice() {
    const span = document.querySelector("#addToCartBtn span");
    if (span) span.textContent = `Add to Bag — CHF ${productPrice * qty}`;
  }

  document.getElementById("addToCartBtn")?.addEventListener("click", () => {
    const cart = JSON.parse(localStorage.getItem("rafia_cart") || "[]");
    for (let i = 0; i < qty; i++) {
      const existing = cart.find((c) => c.id === productId);
      if (existing) {
        existing.qty += 1;
      } else {
        cart.push({
          id: productId,
          name: productName,
          price: productPrice,
          type: productType,
          color: productColor,
          gradient: productGradient,
          svg: productSvg,
          qty: 1,
        });
      }
    }
    localStorage.setItem("rafia_cart", JSON.stringify(cart));

    // Update badge
    const count = cart.reduce((s, i) => s + i.qty, 0);
    document.querySelectorAll(".cart-count").forEach((el) => {
      el.textContent = String(count);
      el.style.display = count > 0 ? "flex" : "none";
      el.classList.remove("bump");
      void el.offsetWidth;
      el.classList.add("bump");
    });

    // Show notification
    let n = document.getElementById("cartNotification");
    if (n) {
      n.innerHTML = `<span style="color:#B8956A;">✓</span>&ensp;${productName} added to bag`;
      n.classList.add("visible");
      clearTimeout(n._timer);
      n._timer = setTimeout(() => n.classList.remove("visible"), 2800);
    }

    const btn = document.getElementById("addToCartBtn");
    if (btn) {
      btn.classList.add("added");
      btn.querySelector("span").textContent = "✓ Added to Bag";
      setTimeout(() => {
        btn.classList.remove("added");
        updatePrice();
      }, 2000);
    }
  });

  // Color swatches
  document.querySelectorAll(".color-swatch").forEach((sw) => {
    sw.addEventListener("click", () => {
      document
        .querySelectorAll(".color-swatch")
        .forEach((s) => s.classList.remove("active"));
      sw.classList.add("active");
    });
  });

  // Accordion
  document.querySelectorAll(".acc-header").forEach((h) => {
    h.addEventListener("click", () => {
      h.parentElement?.classList.toggle("open");
    });
  });
</script>

<style>
  .pdp-info {
    padding-top: 1rem;
  }

  .pdp-type {
    font-size: var(--fs-sm);
    letter-spacing: var(--ls-editorial);
    text-transform: uppercase;
    color: var(--color-gold);
    margin-bottom: 0.8rem;
  }

  .pdp-name {
    font-family: var(--font-display);
    font-size: clamp(2.2rem, 3.5vw, 3.2rem);
    font-weight: var(--fw-light);
    line-height: var(--lh-snug);
    margin-bottom: 1rem;
  }

  .pdp-price {
    font-family: var(--font-display);
    font-size: var(--fs-heading-lg);
    color: var(--color-gold);
    margin-bottom: 2rem;
  }

  .pdp-divider {
    width: 40px;
    height: 1px;
    background: var(--color-gold);
    margin-block: 2rem;
  }

  .pdp-desc {
    font-size: var(--fs-body);
    line-height: var(--lh-loose);
    color: var(--color-espresso-soft);
    margin-bottom: 2rem;
  }

  .pdp-option-label {
    font-size: var(--fs-sm);
    letter-spacing: var(--ls-wider);
    text-transform: uppercase;
    color: var(--color-espresso-soft);
    margin-bottom: 0.8rem;
  }

  .pdp-option-label strong {
    font-weight: var(--fw-regular);
    color: var(--color-espresso);
  }

  .pdp-color-row {
    display: flex;
    gap: 0.8rem;
    margin-bottom: 2rem;
  }

  .pdp-swatch {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-full);
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s;
    position: relative;
  }

  .pdp-swatch:global(.active) {
    border-color: var(--color-espresso);
  }

  .pdp-swatch::after {
    content: "";
    position: absolute;
    inset: -4px;
    border-radius: var(--radius-full);
    border: 1px solid transparent;
    transition: border-color 0.3s;
  }

  .pdp-swatch:global(.active)::after {
    border-color: var(--color-gold);
  }

  .pdp-qty-row {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 2.5rem;
  }

  .pdp-add-btn {
    width: 100%;
    padding: 1.1rem 3rem;
    background: var(--color-espresso);
    color: var(--color-sand-light);
    font-family: var(--font-body);
    font-size: 0.75rem;
    letter-spacing: var(--ls-widest);
    text-transform: uppercase;
    border: none;
    cursor: pointer;
    transition: all 0.5s ease;
  }

  .pdp-secondary {
    display: flex;
    gap: 2rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-sand);
  }

  .pdp-sec-link {
    font-size: var(--fs-caption);
    letter-spacing: var(--ls-wide);
    text-transform: uppercase;
    color: var(--color-espresso-soft);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: color 0.3s;
  }

  .pdp-sec-link:hover {
    color: var(--color-gold);
  }

  .pdp-sec-link svg {
    width: 16px;
    height: 16px;
  }

  .pdp-accordion {
    margin-top: 2.5rem;
  }

  .acc-item {
    border-top: 1px solid var(--color-sand);
  }

  .acc-item:last-child {
    border-bottom: 1px solid var(--color-sand);
  }

  .acc-item:global(.open) .acc-icon::after {
    transform: rotate(90deg);
  }

  .acc-item:global(.open) .acc-body {
    max-height: 300px;
    padding-bottom: 1.5rem;
  }

  .acc-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.3rem 0;
    cursor: pointer;
    user-select: none;
  }

  .acc-header__text {
    font-size: var(--fs-caption);
    letter-spacing: var(--ls-wider);
    text-transform: uppercase;
    color: var(--color-espresso);
  }

  .acc-icon {
    width: 12px;
    height: 12px;
    position: relative;
    transition: transform 0.3s;
  }

  .acc-icon::before {
    content: "";
    position: absolute;
    background: var(--color-espresso);
    width: 12px;
    height: 1px;
    top: 5.5px;
    left: 0;
  }

  .acc-icon::after {
    content: "";
    position: absolute;
    background: var(--color-espresso);
    width: 1px;
    height: 12px;
    left: 5.5px;
    top: 0;
    transition: transform 0.3s;
  }

  .acc-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease, padding 0.4s ease;
  }

  .acc-body__inner {
    font-size: var(--fs-body-sm);
    line-height: var(--lh-relaxed);
    color: var(--color-espresso-soft);
  }

  .acc-body__inner :global(ul) {
    list-style: none;
  }

  .acc-body__inner :global(li) {
    padding: 0.3rem 0;
    display: flex;
    align-items: center;
    gap: 0.8rem;
  }

  .acc-body__inner :global(li)::before {
    content: "";
    width: 4px;
    height: 4px;
    border-radius: var(--radius-full);
    background: var(--color-gold);
    flex-shrink: 0;
  }
</style>

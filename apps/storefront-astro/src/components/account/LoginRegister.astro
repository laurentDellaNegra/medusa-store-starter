---
import { css } from 'styled-system/css'
import { button } from 'styled-system/recipes'

const inputStyles = css({
  w: 'full', h: '10', px: '3',
  borderWidth: '1px', borderColor: 'border.default', borderRadius: 'md', fontSize: 'sm',
  _focus: { outline: 'none', borderColor: 'fg.default' },
})
const labelStyles = css({ display: 'block', fontSize: 'xs', fontWeight: 'medium', mb: '1', color: 'fg.muted' })
---

<div class={css({ display: 'flex', justifyContent: 'center', py: '12', px: '4' })}>
  <!-- Login Form -->
  <div id="login-view" class={css({ maxW: 'sm', w: 'full', display: 'flex', flexDir: 'column', alignItems: 'center' })}>
    <h1 class={css({ fontSize: '2xl', fontWeight: 'bold', textTransform: 'uppercase', mb: '4' })}>Welcome back</h1>
    <p class={css({ textAlign: 'center', fontSize: 'sm', color: 'fg.muted', mb: '8' })}>
      Sign in to access an enhanced shopping experience.
    </p>

    <form id="login-form" class={css({ w: 'full', display: 'flex', flexDir: 'column', gap: '3' })}>
      <div>
        <label class={labelStyles}>Email</label>
        <input type="email" name="email" required autocomplete="email" class={inputStyles} />
      </div>
      <div>
        <label class={labelStyles}>Password</label>
        <input type="password" name="password" required autocomplete="current-password" class={inputStyles} />
      </div>
      <p id="login-error" class={css({ fontSize: 'sm', color: 'fg.error', display: 'none' })}></p>
      <button type="submit" class={`${button({ size: 'lg' })} ${css({ w: 'full', mt: '3' })}`}>Sign in</button>
    </form>

    <p class={css({ textAlign: 'center', fontSize: 'sm', color: 'fg.muted', mt: '6' })}>
      Not a member?{' '}
      <button id="show-register" class={css({ textDecoration: 'underline', cursor: 'pointer', color: 'fg.default' })}>
        Join us
      </button>
    </p>
  </div>

  <!-- Register Form -->
  <div id="register-view" class={css({ maxW: 'sm', w: 'full', display: 'none', flexDir: 'column', alignItems: 'center' })}>
    <h1 class={css({ fontSize: '2xl', fontWeight: 'bold', textTransform: 'uppercase', mb: '4' })}>Become a Member</h1>
    <p class={css({ textAlign: 'center', fontSize: 'sm', color: 'fg.muted', mb: '6' })}>
      Create your account and get access to an enhanced shopping experience.
    </p>

    <form id="register-form" class={css({ w: 'full', display: 'flex', flexDir: 'column', gap: '3' })}>
      <div class={css({ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '3' })}>
        <div>
          <label class={labelStyles}>First name</label>
          <input type="text" name="first_name" required autocomplete="given-name" class={inputStyles} />
        </div>
        <div>
          <label class={labelStyles}>Last name</label>
          <input type="text" name="last_name" required autocomplete="family-name" class={inputStyles} />
        </div>
      </div>
      <div>
        <label class={labelStyles}>Email</label>
        <input type="email" name="email" required autocomplete="email" class={inputStyles} />
      </div>
      <div>
        <label class={labelStyles}>Phone</label>
        <input type="tel" name="phone" autocomplete="tel" class={inputStyles} />
      </div>
      <div>
        <label class={labelStyles}>Password</label>
        <input type="password" name="password" required autocomplete="new-password" class={inputStyles} />
      </div>
      <p id="register-error" class={css({ fontSize: 'sm', color: 'fg.error', display: 'none' })}></p>
      <button type="submit" class={`${button({ size: 'lg' })} ${css({ w: 'full', mt: '3' })}`}>Join</button>
    </form>

    <p class={css({ textAlign: 'center', fontSize: 'sm', color: 'fg.muted', mt: '6' })}>
      Already a member?{' '}
      <button id="show-login" class={css({ textDecoration: 'underline', cursor: 'pointer', color: 'fg.default' })}>
        Sign in
      </button>
    </p>
  </div>
</div>

<script>
  const loginView = document.getElementById('login-view')!
  const registerView = document.getElementById('register-view')!

  document.getElementById('show-register')?.addEventListener('click', () => {
    loginView.style.display = 'none'
    registerView.style.display = 'flex'
  })
  document.getElementById('show-login')?.addEventListener('click', () => {
    registerView.style.display = 'none'
    loginView.style.display = 'flex'
  })

  // Login form
  document.getElementById('login-form')?.addEventListener('submit', async (e) => {
    e.preventDefault()
    const form = e.target as HTMLFormElement
    const btn = form.querySelector('button[type="submit"]') as HTMLButtonElement
    const errorEl = document.getElementById('login-error')!
    const data = Object.fromEntries(new FormData(form))

    btn.disabled = true; btn.textContent = 'Signing in...'
    errorEl.style.display = 'none'

    try {
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      })
      if (!res.ok) {
        const d = await res.json()
        throw new Error(d.error || 'Invalid email or password')
      }
      window.location.reload()
    } catch (err) {
      errorEl.textContent = err instanceof Error ? err.message : 'Login failed'
      errorEl.style.display = 'block'
      btn.disabled = false; btn.textContent = 'Sign in'
    }
  })

  // Register form
  document.getElementById('register-form')?.addEventListener('submit', async (e) => {
    e.preventDefault()
    const form = e.target as HTMLFormElement
    const btn = form.querySelector('button[type="submit"]') as HTMLButtonElement
    const errorEl = document.getElementById('register-error')!
    const data = Object.fromEntries(new FormData(form))

    btn.disabled = true; btn.textContent = 'Creating account...'
    errorEl.style.display = 'none'

    try {
      const res = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      })
      if (!res.ok) {
        const d = await res.json()
        throw new Error(d.error || 'Registration failed')
      }
      window.location.reload()
    } catch (err) {
      errorEl.textContent = err instanceof Error ? err.message : 'Registration failed'
      errorEl.style.display = 'block'
      btn.disabled = false; btn.textContent = 'Join'
    }
  })
</script>

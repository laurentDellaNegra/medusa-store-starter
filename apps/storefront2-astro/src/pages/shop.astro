---
import { css } from "../../styled-system/css";
import BaseLayout from "../layouts/BaseLayout.astro";
import SectionHeader from "../components/SectionHeader.astro";
import FilterBar from "../components/FilterBar.astro";
import ProductCard from "../components/ProductCard.astro";
import { PRODUCTS } from "../data/products";

const shopHeroStyle = css({
  padding: "7rem 2rem 3rem",
  textAlign: "center",
  bg: "sand.pale",
  position: "relative",
  overflow: "hidden",
  _before: {
    content: '""',
    position: "absolute",
    top: "-100px",
    left: "50%",
    transform: "translateX(-50%)",
    width: "800px",
    height: "400px",
    borderRadius: "full",
    background: "radial-gradient(ellipse, rgba(184, 149, 106, 0.08) 0%, transparent 70%)",
  },
  lg: { padding: "10rem 4rem 4rem" },
});

const heroDescStyle = css({
  fontSize: "body",
  lineHeight: "relaxed",
  color: "espresso.soft",
  maxWidth: "500px",
  mx: "auto",
});

const resultsStyle = css({
  fontSize: "caption",
  letterSpacing: "normal",
  color: "espresso.soft",
  padding: "2rem 2rem 0",
  maxWidth: "1400px",
  mx: "auto",
  lg: { padding: "2.5rem 4rem 0" },
});

const gridStyle = css({
  display: "grid",
  gridTemplateColumns: "1fr",
  gap: "3rem 2.5rem",
  maxWidth: "400px",
  mx: "auto",
  padding: "2rem 2rem 5rem",
  md: { gridTemplateColumns: "repeat(2, 1fr)", maxWidth: "1400px", padding: "2rem 3rem 6rem" },
  lg: { gridTemplateColumns: "repeat(3, 1fr)", padding: "2.5rem 4rem 8rem" },
});

const noResultsStyle = css({
  gridColumn: "1 / -1",
  textAlign: "center",
  padding: "4rem 0",
  fontFamily: "display",
  fontSize: "heading.md",
  color: "espresso.soft",
});
---

<BaseLayout title="Collection — Rafia" navVariant="light" activeLink="/shop">
  <section class={shopHeroStyle}>
    <SectionHeader tag="The Collection" title="Our <em>Bags</em>" centered />
    <p class={heroDescStyle}>
      Each piece is a unique creation, hand-woven by Malagasy artisans from
      sustainably harvested raphia palm fibre.
    </p>
  </section>

  <FilterBar />

  <p class={resultsStyle} id="resultsCount"></p>

  <div class={gridStyle} id="shopGrid">
    {PRODUCTS.map((product, i) => (
      <ProductCard product={product} showAddButton animateIn delay={i + 1} />
    ))}
  </div>
</BaseLayout>

<script is:inline define:vars={{ allProducts: PRODUCTS.map(p => ({ id: p.id, name: p.name, type: p.type, color: p.color, price: p.price, badge: p.badge, gradient: p.gradient, svg: p.svg })) }}>
  window.__ALL_PRODUCTS = allProducts;
</script>

<script>
  let currentFilter = "all";
  let currentSort = "featured";

  function renderProducts() {
    const allProducts = (window as any).__ALL_PRODUCTS as any[];
    if (!allProducts) return;

    let items = [...allProducts];
    if (currentFilter !== "all") items = items.filter((p: any) => p.type === currentFilter);
    if (currentSort === "price-asc") items.sort((a: any, b: any) => a.price - b.price);
    else if (currentSort === "price-desc") items.sort((a: any, b: any) => b.price - a.price);
    else if (currentSort === "name") items.sort((a: any, b: any) => a.name.localeCompare(b.name));

    const countEl = document.getElementById("resultsCount");
    if (countEl) countEl.textContent = `Showing ${items.length} piece${items.length !== 1 ? "s" : ""}`;

    const grid = document.getElementById("shopGrid");
    if (!grid) return;
    grid.innerHTML = "";

    if (items.length === 0) {
      grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:4rem 0;font-family:'Cormorant Garamond',serif;font-size:1.5rem;color:#4A3228;">No bags found in this category.</div>`;
      return;
    }

    items.forEach((p: any) => {
      const card = document.createElement("a");
      card.href = `/product?id=${p.id}`;
      card.className = "product-card";
      card.style.cssText = "position:relative;cursor:pointer;text-decoration:none;color:#2C1810;display:block;";
      card.innerHTML = `
        <div style="aspect-ratio:3/4;position:relative;overflow:hidden;margin-bottom:1.5rem;">
          <div class="product-bg" style="position:absolute;inset:0;background:${p.gradient};transition:transform 0.8s ease;"></div>
          <div class="product-shape" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:1;">${p.svg}</div>
          ${p.badge ? `<span style="position:absolute;top:1.2rem;left:1.2rem;padding:0.4rem 1rem;background:rgba(255,252,247,0.9);backdrop-filter:blur(10px);font-size:0.6rem;letter-spacing:0.2em;text-transform:uppercase;color:#B8956A;z-index:2;">${p.badge}</span>` : ""}
          <button class="product-add-btn" style="position:absolute;bottom:1.5rem;left:50%;transform:translateX(-50%) translateY(20px);padding:0.75rem 2rem;background:#2C1810;color:#F4EDE3;font-family:'Outfit',sans-serif;font-size:0.65rem;letter-spacing:0.2em;text-transform:uppercase;border:none;cursor:pointer;opacity:0;transition:all 0.4s ease;z-index:2;white-space:nowrap;">Add to Bag</button>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:400;margin-bottom:0.3rem;">${p.name}</h3>
            <p style="font-size:0.7rem;letter-spacing:0.15em;text-transform:uppercase;color:#4A3228;">${p.type} — ${p.color}</p>
          </div>
          <span style="font-family:'Cormorant Garamond',serif;font-size:1.2rem;color:#B8956A;">CHF ${p.price}</span>
        </div>`;

      // Hover effects
      card.addEventListener("mouseenter", () => {
        const bg = card.querySelector<HTMLElement>(".product-bg");
        const svg = card.querySelector<SVGElement>(".product-shape svg");
        const addBtn = card.querySelector<HTMLElement>(".product-add-btn");
        if (bg) bg.style.transform = "scale(1.05)";
        if (svg) svg.style.transform = "translateY(-8px) rotate(-2deg)";
        if (addBtn) { addBtn.style.opacity = "1"; addBtn.style.transform = "translateX(-50%) translateY(0)"; }
      });
      card.addEventListener("mouseleave", () => {
        const bg = card.querySelector<HTMLElement>(".product-bg");
        const svg = card.querySelector<SVGElement>(".product-shape svg");
        const addBtn = card.querySelector<HTMLElement>(".product-add-btn");
        if (bg) bg.style.transform = "";
        if (svg) svg.style.transform = "";
        if (addBtn) { addBtn.style.opacity = "0"; addBtn.style.transform = "translateX(-50%) translateY(20px)"; }
      });

      // SVG transition
      const shapeSvg = card.querySelector<SVGElement>(".product-shape svg");
      if (shapeSvg) {
        shapeSvg.style.width = "55%";
        shapeSvg.style.filter = "drop-shadow(0 15px 40px rgba(44,24,16,0.15))";
        shapeSvg.style.transition = "transform 0.6s ease";
      }

      // Add to bag click
      const addBtn = card.querySelector<HTMLButtonElement>(".product-add-btn");
      if (addBtn) {
        addBtn.addEventListener("mouseenter", () => { addBtn.style.background = "#B8956A"; });
        addBtn.addEventListener("mouseleave", () => { addBtn.style.background = "#2C1810"; });
        addBtn.addEventListener("click", (e: Event) => {
          e.preventDefault();
          e.stopPropagation();
          const cart: any[] = JSON.parse(localStorage.getItem("rafia_cart") || "[]");
          const existing = cart.find((c: any) => c.id === p.id);
          if (existing) existing.qty += 1;
          else cart.push({ ...p, qty: 1 });
          localStorage.setItem("rafia_cart", JSON.stringify(cart));

          const count = cart.reduce((s: number, i: any) => s + i.qty, 0);
          document.querySelectorAll<HTMLElement>(".cart-count").forEach((el) => {
            el.textContent = String(count);
            el.style.display = count > 0 ? "flex" : "none";
            el.classList.remove("bump");
            void el.offsetWidth;
            el.classList.add("bump");
          });
          const n = document.getElementById("cartNotification");
          if (n) {
            n.innerHTML = `<span style="color:#B8956A;">✓</span>&ensp;${p.name} added to bag`;
            n.classList.add("visible");
            clearTimeout((n as any)._timer);
            (n as any)._timer = setTimeout(() => n.classList.remove("visible"), 2800);
          }
        });
      }

      grid.appendChild(card);
    });
  }

  // Filter buttons
  document.querySelectorAll<HTMLButtonElement>(".filter-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".filter-btn").forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      currentFilter = btn.dataset.filter || "all";
      renderProducts();
    });
  });

  // Sort
  document.getElementById("sortSelect")?.addEventListener("change", (e: Event) => {
    currentSort = (e.target as HTMLSelectElement).value;
    renderProducts();
  });

  // Initial count display
  const countEl = document.getElementById("resultsCount");
  const allProducts = (window as any).__ALL_PRODUCTS as any[];
  if (countEl && allProducts) {
    countEl.textContent = `Showing ${allProducts.length} pieces`;
  }
</script>
